name: Comment Vercel Preview URL

on:
  deployment_status:

permissions:
  deployments: read
  pull-requests: write
  contents: read

jobs:
  comment:
    if: >
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.environment != 'production' &&
      github.event.deployment_status.environment_url != ''
    runs-on: ubuntu-latest
    steps:
      - name: Find PR for this deployment SHA
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.deployment.sha
            const { owner, repo } = context.repo

            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: sha
            })

            if (!prs.data.length) {
              core.setOutput('pr_number', '')
              return
            }

            core.setOutput('pr_number', String(prs.data[0].number))

      - name: Create or update PR comment
        if: steps.find_pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ steps.find_pr.outputs.pr_number }}')
            const url = context.payload.deployment_status.environment_url
            const { owner, repo } = context.repo

            const marker = '<!-- vercel-preview-url -->'
            const body = [
              marker,
              'âœ… **Vercel Preview Ready**',
              url,
              '',
              '**Client review checklist**',
              '- Navigate: Home -> Services -> About -> Contact',
              '- Check mobile layout quickly',
              '- Confirm contact page loads and form UI behaves as expected'
            ].join('\\n')

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100
            })

            const existing = comments.data.find((c) => c.body && c.body.includes(marker))

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              })
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body
              })
            }
